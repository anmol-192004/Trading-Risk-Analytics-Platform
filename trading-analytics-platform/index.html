<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Risk Analytics Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{background:#0e1525;color:#fff;font-family:Arial,sans-serif;margin:0}
    header{padding:15px;background:#131b2f;font-size:22px;font-weight:bold;color:#00c6ff}
    .dashboard{display:flex;gap:20px;padding:20px}
    .card{flex:1;background:#1c253b;padding:20px;border-radius:10px;text-align:center}
    .card h3{margin:0 0 10px;font-size:14px;color:#aaa}
    .card p{font-size:22px;color:#00c6ff;margin:0}
    nav{display:flex;margin:0 20px}
    nav button{flex:1;padding:15px;border:none;background:#1c253b;color:#fff;font-weight:bold;cursor:pointer}
    nav button.active{background:#00c6ff;color:#000}
    section{display:none;padding:20px}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:15px;background:#1c253b;border-radius:8px;overflow:hidden}
    th,td{padding:12px;text-align:center;border-bottom:1px solid #2c3757}
    th{background:#233050;color:#00c6ff}
    tr:hover{background:#2a3555}
    .positive{color:#0f0}.negative{color:#f33}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    canvas{background:#10182e;border-radius:10px;padding:10px}
  </style>
</head>
<body>
<header>â€¢ Trading Risk Analytics Platform</header>

<div class="dashboard">
  <div class="card"><h3>Total Portfolio Value</h3><p id="totalValue">$0.00M</p></div>
  <div class="card"><h3>Average Return</h3><p id="avgReturn">0.00%</p></div>
  <div class="card"><h3>VaR Utilization</h3><p id="avgVar">0.00%</p></div>
  <div class="card"><h3>Sharpe Ratio</h3><p id="sharpeRatio">0.00</p></div>
</div>

<nav>
  <button class="active" onclick="showTab('overview', this)">Portfolio Overview</button>
  <button onclick="showTab('positions', this)">Positions</button>
  <button onclick="showTab('risk', this)">Risk Management</button>
</nav>

<section id="overview" class="active">
  <h2>Portfolio Summary</h2>
  <table id="portfolioTable">
    <thead>
      <tr>
        <th>PORTFOLIO</th><th>STRATEGY</th><th>NAV</th>
        <th>RETURN</th><th>VOLATILITY</th><th>SHARPE</th><th>MAX DD</th><th>RISK STATUS</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="grid">
    <div>
      <h3>Aggregate VaR Headroom</h3>
      <canvas id="varChart" height="160"></canvas>
    </div>
    <div>
      <h3>Sector Exposure (latest)</h3>
      <canvas id="sectorChart" height="160"></canvas>
    </div>
  </div>
</section>

<section id="positions">
  <h2>Current Positions</h2>
  <table id="positionsTable">
    <thead>
      <tr>
        <th>ASSET</th><th>PORTFOLIO</th><th>QUANTITY</th>
        <th>AVG COST</th><th>MARKET PRICE</th><th>MARKET VALUE</th><th>UNREALIZED P&L</th><th>WEIGHT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="risk">
  <h2>Risk Limits Monitor</h2>
  <table id="riskTable">
    <thead>
      <tr>
        <th>PORTFOLIO</th><th>LIMIT TYPE</th><th>LIMIT VALUE</th>
        <th>CURRENT VALUE</th><th>UTILIZATION</th><th>STATUS</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  const fmtUSD = n => `$${Number(n).toLocaleString(undefined,{maximumFractionDigits:2})}`;
  const fmtMM = n => `$${(Number(n)/1e6).toFixed(2)}M`;
  const fmtPct = n => `${Number(n).toFixed(2)}%`;

  let varChart, sectorChart;

  function showTab(id, btn){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    btn.classList.add("active");
  }

  async function loadPortfolioData(){
    const res = await fetch('/api/portfolio-summary');
    const data = await res.json();

    // NAV-weighted KPIs
    const totalNav = data.reduce((s,r)=>s + (+r.current_nav||0), 0);
    const wAvg = (arr, val) => {
      const num = arr.reduce((s,r)=>s + (+r.current_nav||0)*(+r[val]||0), 0);
      return totalNav ? num / totalNav : 0;
    };
    const varTotals = data.reduce((acc,r)=>({
      curr: acc.curr + (+r.current_var||0),
      lim : acc.lim  + (+r.var_limit||0)
    }), {curr:0, lim:0});

    document.getElementById('totalValue').innerText = fmtMM(totalNav);
    document.getElementById('avgReturn').innerText = fmtPct(wAvg(data,'cum_return_pct'));
    document.getElementById('sharpeRatio').innerText = wAvg(data,'sharpe_ratio').toFixed(2);
    document.getElementById('avgVar').innerText = varTotals.lim ? fmtPct((varTotals.curr/varTotals.lim)*100) : '0.00%';

    // Table
    const tb = document.querySelector('#portfolioTable tbody');
    tb.innerHTML = '';
    data.forEach(r=>{
      const ret = +r.cum_return_pct||0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.portfolio_name||'-'}</td>
        <td>${r.strategy_type||'-'}</td>
        <td>${fmtMM(r.current_nav||0)}</td>
        <td class="${ret>=0?'positive':'negative'}">${fmtPct(ret)}</td>
        <td>${fmtPct(r.volatility_pct||0)}</td>
        <td>${(+r.sharpe_ratio||0).toFixed(2)}</td>
        <td>${fmtPct(r.max_drawdown_pct||0)}</td>
        <td>${r.risk_status||'NORMAL'}</td>
      `;
      tb.appendChild(tr);
    });

    // VaR headroom donut
    const headroom = Math.max(varTotals.lim - varTotals.curr, 0);
    const ctx1 = document.getElementById('varChart').getContext('2d');
    if (varChart) varChart.destroy();
    varChart = new Chart(ctx1, {
      type: 'doughnut',
      data: { labels:['Used VaR','Headroom'],
        datasets:[{ data:[varTotals.curr, headroom] }] },
      options:{ plugins:{legend:{position:'bottom'}}}
    });

    // Sector exposure bar
    const sexp = await (await fetch('/api/sector-exposure')).json();
    const labels = sexp.map(x=>x.sector||'Unclassified');
    const vals   = sexp.map(x=>x.market_value||0);
    const ctx2 = document.getElementById('sectorChart').getContext('2d');
    if (sectorChart) sectorChart.destroy();
    sectorChart = new Chart(ctx2, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Market Value', data:vals }] },
      options:{ plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=>'$'+(v/1e6).toFixed(1)+'M' }}} }
    });
  }

  async function loadPositions(){
    const data = await (await fetch('/api/positions')).json();
    const tb = document.querySelector('#positionsTable tbody');
    tb.innerHTML = '';
    data.forEach(r=>{
      const pnl = +r.unrealized_pl||0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.asset}</td>
        <td>${r.portfolio}</td>
        <td>${r.quantity}</td>
        <td>${fmtUSD(r.avg_cost)}</td>
        <td>${fmtUSD(r.market_price)}</td>
        <td>${fmtMM(r.market_value)}</td>
        <td class="${pnl>=0?'positive':'negative'}">${fmtUSD(pnl)}</td>
        <td>${fmtPct(r.weight_pct||0)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  async function loadRisk(){
    const data = await (await fetch('/api/risk-limits')).json();
    const tb = document.querySelector('#riskTable tbody');
    tb.innerHTML = '';
    data.forEach(r=>{
      const isPct = (r.limit_type === 'DRAWDOWN'); // format drawdown as %
      const limitText = isPct ? fmtPct((+r.limit_value||0)*100 ? (+r.limit_value||0) : (+r.limit_value||0)) : fmtMM(r.limit_value||0);
      const currText  = isPct ? fmtPct((+r.current_value||0)*100 ? (+r.current_value||0) : (+r.current_value||0)) : fmtMM(r.current_value||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.portfolio}</td>
        <td>${r.limit_type}</td>
        <td>${limitText}</td>
        <td>${currText}</td>
        <td>${fmtPct(r.utilization_pct||0)}</td>
        <td>${r.status}</td>
      `;
      tb.appendChild(tr);
    });
  }

  loadPortfolioData();
  loadPositions();
  loadRisk();
</script>
</body>
</html>
